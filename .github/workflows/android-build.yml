name: Build Debug APK

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Set up Android SDK
      uses: android-actions/setup-android@v2
      
    - name: Install Android SDK API 34
      run: |
        yes | sdkmanager "platforms;android-34" "build-tools;34.0.0"

    - name: Install NDK and CMake
      run: |
        sdkmanager --install "ndk;25.2.9519653"
        sdkmanager --install "cmake;3.22.1"
        echo "NDK_HOME=$ANDROID_HOME/ndk/25.2.9519653" >> $GITHUB_ENV
        echo "CMAKE_HOME=$ANDROID_HOME/cmake/3.22.1" >> $GITHUB_ENV

    - name: Build Native Libraries
      run: |
        mkdir -p app/src/main/jniLibs/arm64-v8a
        mkdir -p app/src/main/jniLibs/armeabi-v7a
        
        # Build arm64-v8a
        cmake -B build-arm64 -DCMAKE_TOOLCHAIN_FILE=$NDK_HOME/build/cmake/android.toolchain.cmake \
              -DANDROID_ABI=arm64-v8a \
              -DANDROID_PLATFORM=android-21 \
              -S app/src/main/cpp
        cmake --build build-arm64
        
        # Build armeabi-v7a
        cmake -B build-v7a -DCMAKE_TOOLCHAIN_FILE=$NDK_HOME/build/cmake/android.toolchain.cmake \
              -DANDROID_ABI=armeabi-v7a \
              -DANDROID_PLATFORM=android-21 \
              -S app/src/main/cpp
        cmake --build build-v7a
        
        # Copy libraries
        cp build-arm64/libnativehook.so app/src/main/jniLibs/arm64-v8a/
        cp build-v7a/libnativehook.so app/src/main/jniLibs/armeabi-v7a/
        
    - name: Grant gradlew permission
      run: chmod +x gradlew
      
    - name: Check Java version
      run: java -version  

    - name: Build with Gradle
      run: |        
        ./gradlew clean build
        ./gradlew app:dependencies
        ./gradlew assembleDebug \
          --stacktrace \
          --info \
          --no-daemon \
          -Dorg.gradle.parallel=false
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: app-debug.apk
        path: app/build/outputs/apk/debug/app-debug.apk